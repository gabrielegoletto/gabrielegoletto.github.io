const palette_int = {
	'P02_107': ['hsl(62, 60%, 60%)', 'hsl(8, 60%, 60%)', 'hsl(290, 60%, 60%)', 'hsl(102, 60%, 60%)', 'hsl(147, 60%, 60%)', 'hsl(303, 60%, 60%)', 'hsl(40, 60%, 60%)', 'hsl(243, 60%, 60%)', 'hsl(291, 60%, 60%)', 'hsl(64, 60%, 60%)', 'hsl(311, 60%, 60%)', 'hsl(233, 60%, 60%)', 'hsl(219, 60%, 60%)'],
	'P03_24': ['hsl(224, 60%, 60%)', 'hsl(291, 60%, 60%)', 'hsl(4, 60%, 60%)', 'hsl(18, 60%, 60%)', 'hsl(113, 60%, 60%)', 'hsl(163, 60%, 60%)', 'hsl(130, 60%, 60%)', 'hsl(242, 60%, 60%)', 'hsl(134, 60%, 60%)', 'hsl(323, 60%, 60%)', 'hsl(107, 60%, 60%)', 'hsl(103, 60%, 60%)', 'hsl(284, 60%, 60%)', 'hsl(16, 60%, 60%)', 'hsl(241, 60%, 60%)', 'hsl(64, 60%, 60%)', 'hsl(15, 60%, 60%)', 'hsl(27, 60%, 60%)', 'hsl(243, 60%, 60%)', 'hsl(258, 60%, 60%)', 'hsl(315, 60%, 60%)', 'hsl(2, 60%, 60%)', 'hsl(2, 60%, 60%)', 'hsl(163, 60%, 60%)', 'hsl(35, 60%, 60%)', 'hsl(139, 60%, 60%)', 'hsl(321, 60%, 60%)', 'hsl(271, 60%, 60%)', 'hsl(160, 60%, 60%)', 'hsl(179, 60%, 60%)', 'hsl(73, 60%, 60%)', 'hsl(222, 60%, 60%)', 'hsl(133, 60%, 60%)', 'hsl(212, 60%, 60%)', 'hsl(336, 60%, 60%)', 'hsl(54, 60%, 60%)', 'hsl(69, 60%, 60%)', 'hsl(36, 60%, 60%)', 'hsl(292, 60%, 60%)', 'hsl(280, 60%, 60%)', 'hsl(295, 60%, 60%)', 'hsl(326, 60%, 60%)'],
	'P04_25': ['hsl(110, 60%, 60%)', 'hsl(359, 60%, 60%)', 'hsl(230, 60%, 60%)', 'hsl(244, 60%, 60%)', 'hsl(180, 60%, 60%)', 'hsl(141, 60%, 60%)', 'hsl(185, 60%, 60%)', 'hsl(237, 60%, 60%)', 'hsl(67, 60%, 60%)', 'hsl(320, 60%, 60%)', 'hsl(344, 60%, 60%)', 'hsl(346, 60%, 60%)', 'hsl(32, 60%, 60%)', 'hsl(299, 60%, 60%)', 'hsl(70, 60%, 60%)', 'hsl(186, 60%, 60%)', 'hsl(232, 60%, 60%)', 'hsl(303, 60%, 60%)', 'hsl(31, 60%, 60%)', 'hsl(278, 60%, 60%)', 'hsl(273, 60%, 60%)', 'hsl(57, 60%, 60%)', 'hsl(152, 60%, 60%)'],
	'P06_13': ['hsl(13, 60%, 60%)', 'hsl(100, 60%, 60%)', 'hsl(9, 60%, 60%)', 'hsl(156, 60%, 60%)', 'hsl(114, 60%, 60%)', 'hsl(29, 60%, 60%)', 'hsl(313, 60%, 60%)', 'hsl(264, 60%, 60%)', 'hsl(187, 60%, 60%)', 'hsl(311, 60%, 60%)', 'hsl(195, 60%, 60%)', 'hsl(185, 60%, 60%)', 'hsl(190, 60%, 60%)', 'hsl(218, 60%, 60%)', 'hsl(41, 60%, 60%)', 'hsl(20, 60%, 60%)', 'hsl(299, 60%, 60%)', 'hsl(33, 60%, 60%)', 'hsl(21, 60%, 60%)', 'hsl(212, 60%, 60%)', 'hsl(149, 60%, 60%)', 'hsl(125, 60%, 60%)', 'hsl(348, 60%, 60%)', 'hsl(342, 60%, 60%)'],
	'P11_101': ['hsl(210, 60%, 60%)', 'hsl(192, 60%, 60%)', 'hsl(151, 60%, 60%)', 'hsl(62, 60%, 60%)', 'hsl(48, 60%, 60%)', 'hsl(317, 60%, 60%)', 'hsl(229, 60%, 60%)', 'hsl(211, 60%, 60%)', 'hsl(308, 60%, 60%)', 'hsl(170, 60%, 60%)', 'hsl(219, 60%, 60%)', 'hsl(72, 60%, 60%)', 'hsl(104, 60%, 60%)'],
	'P15_02': ['hsl(127, 60%, 60%)', 'hsl(88, 60%, 60%)', 'hsl(358, 60%, 60%)', 'hsl(217, 60%, 60%)', 'hsl(294, 60%, 60%)', 'hsl(238, 60%, 60%)', 'hsl(221, 60%, 60%)', 'hsl(133, 60%, 60%)', 'hsl(321, 60%, 60%)', 'hsl(331, 60%, 60%)', 'hsl(259, 60%, 60%)', 'hsl(146, 60%, 60%)', 'hsl(37, 60%, 60%)', 'hsl(112, 60%, 60%)', 'hsl(153, 60%, 60%)', 'hsl(33, 60%, 60%)', 'hsl(2, 60%, 60%)', 'hsl(53, 60%, 60%)', 'hsl(252, 60%, 60%)', 'hsl(307, 60%, 60%)', 'hsl(62, 60%, 60%)', 'hsl(261, 60%, 60%)', 'hsl(177, 60%, 60%)', 'hsl(117, 60%, 60%)', 'hsl(257, 60%, 60%)', 'hsl(180, 60%, 60%)', 'hsl(327, 60%, 60%)', 'hsl(277, 60%, 60%)', 'hsl(59, 60%, 60%)', 'hsl(322, 60%, 60%)', 'hsl(72, 60%, 60%)', 'hsl(76, 60%, 60%)', 'hsl(262, 60%, 60%)', 'hsl(92, 60%, 60%)', 'hsl(240, 60%, 60%)', 'hsl(5, 60%, 60%)', 'hsl(49, 60%, 60%)', 'hsl(85, 60%, 60%)'],
	'P17_01': ['hsl(144, 60%, 60%)', 'hsl(61, 60%, 60%)', 'hsl(45, 60%, 60%)', 'hsl(115, 60%, 60%)', 'hsl(309, 60%, 60%)', 'hsl(17, 60%, 60%)', 'hsl(217, 60%, 60%)', 'hsl(22, 60%, 60%)', 'hsl(310, 60%, 60%)', 'hsl(202, 60%, 60%)', 'hsl(236, 60%, 60%)', 'hsl(37, 60%, 60%)', 'hsl(31, 60%, 60%)', 'hsl(188, 60%, 60%)', 'hsl(179, 60%, 60%)', 'hsl(301, 60%, 60%)', 'hsl(6, 60%, 60%)'],
	'P22_01': ['hsl(322, 60%, 60%)', 'hsl(54, 60%, 60%)', 'hsl(51, 60%, 60%)', 'hsl(122, 60%, 60%)', 'hsl(184, 60%, 60%)', 'hsl(133, 60%, 60%)', 'hsl(17, 60%, 60%)', 'hsl(182, 60%, 60%)', 'hsl(102, 60%, 60%)', 'hsl(263, 60%, 60%)', 'hsl(158, 60%, 60%)', 'hsl(90, 60%, 60%)', 'hsl(13, 60%, 60%)', 'hsl(150, 60%, 60%)', 'hsl(42, 60%, 60%)', 'hsl(93, 60%, 60%)', 'hsl(129, 60%, 60%)', 'hsl(186, 60%, 60%)', 'hsl(292, 60%, 60%)', 'hsl(152, 60%, 60%)', 'hsl(118, 60%, 60%)', 'hsl(254, 60%, 60%)', 'hsl(2, 60%, 60%)', 'hsl(335, 60%, 60%)', 'hsl(159, 60%, 60%)', 'hsl(352, 60%, 60%)', 'hsl(133, 60%, 60%)', 'hsl(7, 60%, 60%)', 'hsl(338, 60%, 60%)', 'hsl(15, 60%, 60%)', 'hsl(341, 60%, 60%)', 'hsl(43, 60%, 60%)', 'hsl(310, 60%, 60%)', 'hsl(219, 60%, 60%)', 'hsl(215, 60%, 60%)', 'hsl(26, 60%, 60%)', 'hsl(121, 60%, 60%)', 'hsl(316, 60%, 60%)', 'hsl(304, 60%, 60%)', 'hsl(87, 60%, 60%)', 'hsl(226, 60%, 60%)', 'hsl(137, 60%, 60%)', 'hsl(146, 60%, 60%)', 'hsl(160, 60%, 60%)', 'hsl(57, 60%, 60%)', 'hsl(246, 60%, 60%)', 'hsl(264, 60%, 60%)', 'hsl(114, 60%, 60%)', 'hsl(29, 60%, 60%)', 'hsl(187, 60%, 60%)', 'hsl(79, 60%, 60%)', 'hsl(90, 60%, 60%)', 'hsl(280, 60%, 60%)', 'hsl(252, 60%, 60%)', 'hsl(81, 60%, 60%)', 'hsl(244, 60%, 60%)', 'hsl(355, 60%, 60%)', 'hsl(88, 60%, 60%)', 'hsl(201, 60%, 60%)', 'hsl(43, 60%, 60%)', 'hsl(132, 60%, 60%)', 'hsl(145, 60%, 60%)', 'hsl(213, 60%, 60%)', 'hsl(90, 60%, 60%)', 'hsl(137, 60%, 60%)', 'hsl(288, 60%, 60%)', 'hsl(344, 60%, 60%)', 'hsl(312, 60%, 60%)', 'hsl(144, 60%, 60%)', 'hsl(254, 60%, 60%)', 'hsl(215, 60%, 60%)', 'hsl(158, 60%, 60%)', 'hsl(26, 60%, 60%)', 'hsl(324, 60%, 60%)', 'hsl(242, 60%, 60%)', 'hsl(48, 60%, 60%)'],
	'P28_101': ['hsl(162, 60%, 60%)', 'hsl(332, 60%, 60%)', 'hsl(281, 60%, 60%)', 'hsl(82, 60%, 60%)', 'hsl(278, 60%, 60%)', 'hsl(229, 60%, 60%)', 'hsl(274, 60%, 60%)', 'hsl(166, 60%, 60%)', 'hsl(227, 60%, 60%)', 'hsl(121, 60%, 60%)', 'hsl(172, 60%, 60%)', 'hsl(231, 60%, 60%)', 'hsl(282, 60%, 60%)', 'hsl(89, 60%, 60%)', 'hsl(343, 60%, 60%)', 'hsl(194, 60%, 60%)', 'hsl(132, 60%, 60%)', 'hsl(205, 60%, 60%)', 'hsl(151, 60%, 60%)', 'hsl(279, 60%, 60%)', 'hsl(272, 60%, 60%)', 'hsl(217, 60%, 60%)', 'hsl(336, 60%, 60%)', 'hsl(125, 60%, 60%)', 'hsl(226, 60%, 60%)', 'hsl(124, 60%, 60%)', 'hsl(209, 60%, 60%)', 'hsl(124, 60%, 60%)', 'hsl(135, 60%, 60%)', 'hsl(136, 60%, 60%)', 'hsl(307, 60%, 60%)', 'hsl(325, 60%, 60%)', 'hsl(24, 60%, 60%)', 'hsl(176, 60%, 60%)', 'hsl(289, 60%, 60%)', 'hsl(63, 60%, 60%)', 'hsl(193, 60%, 60%)', 'hsl(328, 60%, 60%)', 'hsl(296, 60%, 60%)', 'hsl(256, 60%, 60%)', 'hsl(296, 60%, 60%)', 'hsl(202, 60%, 60%)', 'hsl(53, 60%, 60%)', 'hsl(224, 60%, 60%)', 'hsl(20, 60%, 60%)', 'hsl(9, 60%, 60%)'],
	'P35_109': ['hsl(110, 60%, 60%)', 'hsl(150, 60%, 60%)', 'hsl(306, 60%, 60%)', 'hsl(74, 60%, 60%)', 'hsl(49, 60%, 60%)', 'hsl(116, 60%, 60%)', 'hsl(257, 60%, 60%)', 'hsl(321, 60%, 60%)', 'hsl(288, 60%, 60%)', 'hsl(136, 60%, 60%)', 'hsl(335, 60%, 60%)', 'hsl(289, 60%, 60%)', 'hsl(349, 60%, 60%)', 'hsl(353, 60%, 60%)', 'hsl(255, 60%, 60%)', 'hsl(223, 60%, 60%)', 'hsl(103, 60%, 60%)', 'hsl(85, 60%, 60%)', 'hsl(121, 60%, 60%)', 'hsl(153, 60%, 60%)', 'hsl(106, 60%, 60%)', 'hsl(346, 60%, 60%)', 'hsl(82, 60%, 60%)', 'hsl(76, 60%, 60%)', 'hsl(299, 60%, 60%)', 'hsl(303, 60%, 60%)', 'hsl(90, 60%, 60%)', 'hsl(248, 60%, 60%)', 'hsl(37, 60%, 60%)', 'hsl(219, 60%, 60%)', 'hsl(319, 60%, 60%)', 'hsl(48, 60%, 60%)', 'hsl(272, 60%, 60%)', 'hsl(158, 60%, 60%)', 'hsl(34, 60%, 60%)', 'hsl(211, 60%, 60%)', 'hsl(246, 60%, 60%)', 'hsl(120, 60%, 60%)', 'hsl(8, 60%, 60%)', 'hsl(18, 60%, 60%)', 'hsl(76, 60%, 60%)', 'hsl(127, 60%, 60%)', 'hsl(35, 60%, 60%)', 'hsl(240, 60%, 60%)', 'hsl(27, 60%, 60%)', 'hsl(294, 60%, 60%)', 'hsl(304, 60%, 60%)', 'hsl(306, 60%, 60%)', 'hsl(352, 60%, 60%)', 'hsl(167, 60%, 60%)', 'hsl(168, 60%, 60%)', 'hsl(176, 60%, 60%)', 'hsl(281, 60%, 60%)', 'hsl(147, 60%, 60%)', 'hsl(348, 60%, 60%)', 'hsl(97, 60%, 60%)', 'hsl(71, 60%, 60%)', 'hsl(232, 60%, 60%)', 'hsl(265, 60%, 60%)', 'hsl(133, 60%, 60%)', 'hsl(279, 60%, 60%)']
};

const palette_loc = {
	'P02_107': ['hsl(150, 60%, 60%)', 'hsl(262, 60%, 60%)', 'hsl(3, 60%, 60%)', 'hsl(348, 60%, 60%)', 'hsl(60, 60%, 60%)'],
	'P03_24': ['hsl(159, 60%, 60%)', 'hsl(263, 60%, 60%)', 'hsl(178, 60%, 60%)', 'hsl(208, 60%, 60%)', 'hsl(234, 60%, 60%)', 'hsl(103, 60%, 60%)', 'hsl(41, 60%, 60%)', 'hsl(47, 60%, 60%)', 'hsl(288, 60%, 60%)', 'hsl(18, 60%, 60%)', 'hsl(327, 60%, 60%)', 'hsl(78, 60%, 60%)', 'hsl(56, 60%, 60%)', 'hsl(237, 60%, 60%)', 'hsl(109, 60%, 60%)', 'hsl(205, 60%, 60%)', 'hsl(41, 60%, 60%)', 'hsl(92, 60%, 60%)'],
	'P04_25': ['hsl(216, 60%, 60%)', 'hsl(19, 60%, 60%)', 'hsl(243, 60%, 60%)', 'hsl(48, 60%, 60%)', 'hsl(150, 60%, 60%)'],
	'P06_13': ['hsl(61, 60%, 60%)', 'hsl(249, 60%, 60%)', 'hsl(150, 60%, 60%)'],
	'P11_101': ['hsl(231, 60%, 60%)', 'hsl(239, 60%, 60%)', 'hsl(324, 60%, 60%)', 'hsl(262, 60%, 60%)', 'hsl(95, 60%, 60%)', 'hsl(150, 60%, 60%)'],
	'P15_02': ['hsl(99, 60%, 60%)', 'hsl(251, 60%, 60%)', 'hsl(182, 60%, 60%)', 'hsl(28, 60%, 60%)', 'hsl(120, 60%, 60%)'],
	'P17_01': ['hsl(188, 60%, 60%)', 'hsl(41, 60%, 60%)'],
	'P22_01': ['hsl(48, 60%, 60%)', 'hsl(310, 60%, 60%)', 'hsl(342, 60%, 60%)', 'hsl(236, 60%, 60%)', 'hsl(62, 60%, 60%)', 'hsl(320, 60%, 60%)', 'hsl(326, 60%, 60%)', 'hsl(25, 60%, 60%)', 'hsl(27, 60%, 60%)', 'hsl(334, 60%, 60%)', 'hsl(295, 60%, 60%)', 'hsl(9, 60%, 60%)', 'hsl(235, 60%, 60%)', 'hsl(311, 60%, 60%)', 'hsl(146, 60%, 60%)', 'hsl(120, 60%, 60%)'],
	'P28_101': ['hsl(177, 60%, 60%)', 'hsl(74, 60%, 60%)', 'hsl(10, 60%, 60%)', 'hsl(163, 60%, 60%)', 'hsl(202, 60%, 60%)', 'hsl(34, 60%, 60%)', 'hsl(347, 60%, 60%)', 'hsl(94, 60%, 60%)', 'hsl(197, 60%, 60%)', 'hsl(307, 60%, 60%)', 'hsl(346, 60%, 60%)', 'hsl(239, 60%, 60%)', 'hsl(280, 60%, 60%)'],
	'P35_109': ['hsl(287, 60%, 60%)', 'hsl(35, 60%, 60%)', 'hsl(174, 60%, 60%)', 'hsl(138, 60%, 60%)', 'hsl(326, 60%, 60%)', 'hsl(277, 60%, 60%)', 'hsl(22, 60%, 60%)', 'hsl(105, 60%, 60%)', 'hsl(238, 60%, 60%)', 'hsl(67, 60%, 60%)', 'hsl(153, 60%, 60%)', 'hsl(200, 60%, 60%)', 'hsl(77, 60%, 60%)', 'hsl(337, 60%, 60%)', 'hsl(108, 60%, 60%)', 'hsl(325, 60%, 60%)', 'hsl(247, 60%, 60%)', 'hsl(187, 60%, 60%)', 'hsl(300, 60%, 60%)']
};

const QsExamples = {
	"Example1_Q1": 'Q1_001200',
	"Example2_Q1": 'Q1_003200',
	"Example1_Q2": 'Q2_001200',
	"Example2_Q2": 'Q2_003000',
	"Example1_Q3": 'Q3_000350',
	"Example2_Q3": 'Q3_002700',
	"Example1_Q4": 'Q4_000500',
	"Example2_Q4": 'Q4_001000',
	"Example1_Q5": 'Q5_001150',
	"Example2_Q5": 'Q5_002100',
	"Example1_Q6": 'Q6_001100',
	"Example2_Q6": 'Q6_002000',
	"Example1_Q7": 'Q7_000100',
	"Example2_Q7": 'Q7_002500',
	"Example1_Q8": 'Q8_000150',
	"Example2_Q8": 'Q8_000650'
};

window.HELP_IMPROVE_VIDEOJS = false;


$(document).ready(function () {
	// Check for click events on the navbar burger icon

	var options = {
		slidesToScroll: 1,
		slidesToShow: 1,
		loop: true,
		infinite: true,
		autoplay: false,
		autoplaySpeed: 5000,
	};

	bulmaCarousel.attach('.carousel', options);
	bulmaSlider.attach();

});

// Declare global variables to store JSON data
let maxStopFrame = null;
let frame2pix = null;
let fps = null;
let currentOverlay = null;

function secondsToMMSS(seconds) {
	const minutes = Math.floor(seconds / 60);
	const remainingSeconds = Math.floor(seconds % 60);
	// Ensure both minutes and seconds are always two digits
	return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
}

function hideImagePreview() {
	const preview = document.getElementById('preview_space');
	preview.innerHTML = '';
	const previewCluster = document.getElementById('preview_space_cluster');
	previewCluster.innerHTML = '';
}

// Function to zoom in elements
function ZoomIn() {
	const clusterButtons = document.getElementsByClassName('cluster-button');
	for (let button of clusterButtons) {
		button.style.left = (parseFloat(button.style.left) * 2) + 'px';
		button.style.width = (parseFloat(button.style.width) * 2) + 'px';
	}

	frame2pix *= 2;
	adjustTicklines(2);
}

// Function to zoom out elements
function ZoomOut() {
	const clusterButtons = document.getElementsByClassName('cluster-button');
	for (let button of clusterButtons) {
		button.style.left = (parseFloat(button.style.left) / 2) + 'px';
		button.style.width = (parseFloat(button.style.width) / 2) + 'px';
	}

	frame2pix /= 2;
	adjustTicklines(0.5);
}

// Adjust tickline scaling and generation
function adjustTicklines(scaleFactor) {
	const lines = document.getElementsByClassName('tickline');
	for (let line of lines) {
		line.style.width = (parseFloat(line.style.width) * scaleFactor) + 'px';
		line.setAttribute('tick_num', line.getAttribute('tick_num') * scaleFactor);
		generateTicks(line);
	}
}

// Function to create cluster buttons for hands and location data
function createButtonsHands(data, dataLoc, videoId) {
	maxStopFrame = videoId.startsWith('P') ? epic_data_info[videoId].num_frames : ego4d_data_info[videoId].num_frames;

	const dataRight = data[videoId].filter(item => item.direction === 'right');
	const dataLeft = data[videoId].filter(item => item.direction === 'left');
	const viewportWidth = document.getElementById('reset').offsetWidth - 150;
	frame2pix = viewportWidth / (fps * 120);

	const dataLocVideo = dataLoc[videoId];

	const maxClusterId = Math.max(getMaxId(dataRight), getMaxId(dataLeft)) + 1;
	const palette = palette_int[videoId] ? palette_int[videoId] : generateColorPalette(maxClusterId);
	const paletteLoc = palette_loc[videoId] ? palette_loc[videoId] : generateColorPaletteLoc(getMaxId(dataLocVideo));

	const tickline = document.getElementById('tickline');
	tickline.innerHTML = "";
	// Create the tickline
	const line = createTickline(maxStopFrame, frame2pix);
	tickline.appendChild(line);

	// Create buttons for right hand and left hand clusters
	const rightButtonContainer = document.getElementById('right-hand');
	rightButtonContainer.innerHTML = '';
	const leftButtonContainer = document.getElementById('left-hand');
	leftButtonContainer.innerHTML = '';
	const locationButtonContainer = document.getElementById('location');
	locationButtonContainer.innerHTML = '';
	createClusterButtons(data[videoId], dataRight, palette, rightButtonContainer, videoId);
	createClusterButtons(data[videoId], dataLeft, palette, leftButtonContainer, videoId);

	// Create buttons for location clusters
	createLocationButtons(dataLocVideo, paletteLoc, locationButtonContainer, videoId);

	generateTicks(line);
}

// Function to create cluster buttons for hands
function createClusterButtons(all_data, data, palette, buttonContainer, videoId) {
	const clusters = Array.from(new Set(data.map(item => item.cluster)));
	for (let clusterId of clusters) {
		const clusterData = data.filter(item => item.cluster == clusterId);
		clusterData.forEach(item => {
			const range = [item.track_num, item.start_frame, item.end_frame];
			const button = createClusterButton(range, palette[clusterId], all_data, videoId, clusterId);
			buttonContainer.appendChild(button);
		});
	}
}

// Function to create location buttons
function createLocationButtons(dataLoc, paletteLoc, buttonContainer, videoId) {
	const clusters = Array.from(new Set(dataLoc.map(item => item.cluster)));
	for (let clusterId of clusters) {
		const clusterData = dataLoc.filter(item => item.cluster == clusterId);
		clusterData.forEach(item => {
			const range = [item.track_num, item.start_frame, item.end_frame];
			const button = createLocationButton(range, paletteLoc[clusterId], dataLoc, videoId, clusterId);
			buttonContainer.appendChild(button);
		});
	}
}

// Helper function to create individual cluster buttons
function createClusterButton(frameRange, color, data, videoId, clusterId) {
	const button = document.createElement('button');
	button.className = 'cluster-button';
	button.style.left = (frameRange[1] * frame2pix) + 'px';
	button.style.width = ((frameRange[2] - frameRange[1]) * frame2pix) + 'px';
	button.style.backgroundColor = color;

	button.setAttribute('cluster', clusterId);
	button.setAttribute('track_num', frameRange[0]);
	button.addEventListener('click', () => showClusterPreview(data, clusterId, frameRange[0], videoId));

	return button;
}

// Function to create location buttons
function createLocationButton(frameRange, color, data, videoId, clusterId) {
	const button = document.createElement('button');
	button.className = 'cluster-button';
	button.style.left = (frameRange[1] * frame2pix) + 'px';
	button.style.width = ((frameRange[2] - frameRange[1]) * frame2pix) + 'px';
	button.style.backgroundColor = color;

	const image_src = `${videoId}/location/thumbs/${String(frameRange[0]).padStart(4, '0')}.jpg`;
	const cluster_src = `${videoId}/location/cluster_thumbs/${String(clusterId).padStart(4, '0')}.jpg`;

	button.setAttribute('data-image-src', image_src);
	button.setAttribute('data-image-cluster-src', cluster_src);
	button.setAttribute('track_num', frameRange[0]);
	button.setAttribute('cluster', clusterId);

	button.addEventListener('click', () => showLocationPreview(data, clusterId, frameRange[0], videoId));

	return button;
}

// Function to show cluster preview for hands
function showClusterPreview(data, clusterId, trackNum, videoId) {
	updatePreviewSpace(trackNum, videoId, false);
	updateClusterSpace(data, trackNum, videoId, clusterId, false);
}

// Function to show preview for location clusters
function showLocationPreview(data, clusterId, trackNum, videoId) {
	updatePreviewSpace(trackNum, videoId, true);
	updateClusterSpace(data, trackNum, videoId, clusterId, true);
}

// Function to update the preview space for cluster buttons
function updatePreviewSpace(trackNum, videoId, loc) {
	const imagePreview = document.getElementById('preview_space');
	imagePreview.innerHTML = ''; // Clear any previous content

	const containerDiv = document.createElement('div');
	containerDiv.style.display = 'flex';
	containerDiv.style.flexDirection = 'row';
	containerDiv.style.alignItems = 'center';
	containerDiv.style.justifyContent = 'center';
	containerDiv.style.height = '100%';
	containerDiv.style.pointerEvents = 'auto';

	const trackText = document.createElement('p');
	trackText.textContent = 'Selected track';
	trackText.style.marginRight = '10px';
	containerDiv.appendChild(trackText);

	// Create a container for the close icon (can use a div or button)
	let closeBtnWrapper = document.createElement('div');
	closeBtnWrapper.style.cursor = 'pointer';
	closeBtnWrapper.style.zIndex = '999';
	closeBtnWrapper.style.display = 'inline-flex';

	// Create the icon element
	let closeBtn = document.createElement('i');
	closeBtn.className = 'fas fa-times-circle';
	closeBtn.id = 'close-btn';

	// Append the icon to the wrapper
	closeBtnWrapper.appendChild(closeBtn);

	// Add the click event to the wrapper
	closeBtnWrapper.addEventListener('click', () => {
		hideImagePreview(); // Call your function here
	});

	// Append the wrapper to the flex container
	containerDiv.appendChild(closeBtnWrapper);
	imagePreview.appendChild(containerDiv);


	// Create and append the image
	const img = document.createElement('img');
	img.src = loc ? 'static/images/' + videoId + '/' + trackNum + '_loc.png' : 'static/images/' + videoId + '/' + trackNum + '.png';
	img.alt = 'Image';
	img.style.maxWidth = "100%";
	img.style.height = "auto";
	imagePreview.style.display = "flex";
	imagePreview.style.flexDirection = "column";
	imagePreview.style.alignItems = "center";
	imagePreview.appendChild(img);
}

// Function to update the cluster space
function updateClusterSpace(data, trackNum, videoId, clusterId, loc) {
	const clusterPreview = document.getElementById('preview_space_cluster');
	clusterPreview.innerHTML = '';

	const instanceText = document.createElement('p');
	instanceText.textContent = `Instance ${clusterId}`;
	instanceText.style.textAlign = 'center';
	clusterPreview.appendChild(instanceText);

	clusterPreview.style.flexDirection = "column";
	clusterPreview.style.alignItems = "center";

	const imgs = data.filter(item => item.cluster == clusterId && item.track_num != trackNum);
	const imagesContainer = document.createElement('div');
	imagesContainer.style.display = 'flex';
	imagesContainer.style.flexWrap = 'wrap';
	imagesContainer.style.justifyContent = 'center';

	for (let el of imgs) {
		const img = document.createElement('img');
		img.src = loc ? 'static/images/' + videoId + '/' + el.track_num + '_loc.png' : 'static/images/' + videoId + '/' + el.track_num + '.png';
		img.alt = 'Image';
		img.style.maxWidth = "30%";
		img.style.height = "auto";
		img.style.margin = "10px";
		imagesContainer.appendChild(img);
	}

	clusterPreview.appendChild(imagesContainer);
}

function generateTicks(line) {
	line.innerHTML = '';
	const tickNum = parseInt(line.getAttribute('tick_num'));
	const availableWidth = line.clientWidth;
	const minTickSpacing = 50;
	const maxTicksWithoutOverlap = Math.floor(availableWidth / minTickSpacing);

	let skipFactor = Math.ceil(tickNum / maxTicksWithoutOverlap);

	for (let i = 0; i <= tickNum; i++) {
		if (i % skipFactor !== 0) continue;

		const tick = document.createElement('div');
		tick.className = 'tick';
		tick.style.left = ((maxStopFrame - 1) / tickNum) * i * frame2pix + 'px';

		const ticktext = document.createElement('div');
		ticktext.className = 'tick_text';
		ticktext.style.left = Math.max((((maxStopFrame - 1) / tickNum) * i * frame2pix) - 10, 0) + 'px';
		ticktext.textContent = secondsToMMSS(((maxStopFrame * i) / tickNum) / fps);

		line.appendChild(tick);
		line.appendChild(ticktext);
	}
}

// Utility function to create tickline for the video
function createTickline(maxFrame, frame2pix) {
	const tickline = document.createElement('div');
	tickline.className = 'tickline';
	tickline.setAttribute('tick_num', '10');
	tickline.style.width = maxFrame * frame2pix + 'px';
	return tickline;
}

// Utility function to get the maximum cluster ID from data
function getMaxId(data) {
	return Math.max(...data.map(item => item.cluster).map(Number));
}

// Utility function to generate a color palette
function generateColorPalette(maxId) {
	const palette = [];
	const numColors = maxId; // Specify the number of colors you want

	for (let i = 0; i < numColors; i++) {
		// Generate a random hue value between 0 and 360
		const hue = Math.floor(Math.random() * 360);
		const saturation = 60; // Lower saturation for pastel colors
		const lightness = 60;  // Higher lightness for pastel colors
		palette.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
	}

	return palette;
}

// Utility function to generate a color palette
function generateColorPaletteLoc(maxId) {
	const palette = [];
	const numColors = maxId; // Specify the number of colors you want

	for (let i = 0; i < numColors; i++) {
		// Generate a random hue value between 0 and 360
		const hue = Math.floor(Math.random() * 360);
		const saturation = 60; // Lower saturation for pastel colors
		const lightness = 60;  // Higher lightness for pastel colors
		palette.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
	}

	return palette;
}

function changeVideo(videoId) {
	// hideImagePreview(); // Hide image preview (if any)

	// Determine the FPS from the selected video
	fps = videoId.startsWith('P') ? Math.ceil(parseFloat(epic_data_info[videoId].fps)) : Math.ceil(parseFloat(ego4d_data_info[videoId].fps));

	var timeline = document.getElementById("timeline");
	timeline.classList.remove('hidden');

	// Update video container with zoom controls and selected video info
	var videoContainer = document.getElementById("video-container");
	videoContainer.innerHTML = `
		<div class="d-flex align-items-center justify-content-between mt-3">
			<div>
				<a class="btn mr-2" onclick="ZoomIn()">
					<i class="fas fa-search-plus"></i>
				</a>
				<a class="btn" onclick="ZoomOut()">
					<i class="fas fa-search-minus"></i>
				</a>
			</div>
			<div>
				<b>You selected video ${videoId}</b>
			</div>
		</div>
	`;

	createButtonsHands(all_videos, all_videos_loc, videoId);
	const preview = document.getElementById('preview_space');
	preview.innerHTML = '';
	const previewCluster = document.getElementById('preview_space_cluster');
	previewCluster.innerHTML = '';
	return false;
}

document.addEventListener('DOMContentLoaded', function () {
	changeVideo('P02_107');
});

$(document).ready(function () {
	// Check for click events on the navbar burger icon
	$(".navbar-burger").click(function () {
		// Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		$(".navbar-burger").toggleClass("is-active");
		$(".navbar-menu").toggleClass("is-active");
	});
});

function createOverlay(coords, color) {
	const overlay = document.createElement('div');
	overlay.style.position = 'absolute';
	overlay.style.border = `2px solid ${color}`;
	overlay.style.pointerEvents = 'none';
	overlay.style.zIndex = '999';
	positionOverlay(overlay, coords);
	return overlay;
}

function positionOverlay(overlay, coords) {
	const imageMap = document.querySelector('img[usemap]');
	const [x1, y1, x2, y2] = coords.split(',').map(Number);
    const rect = imageMap.getBoundingClientRect();
	console.log(rect.left);
	console.log(rect.top);
	console.log(x1);
	console.log(x2);
	console.log(y1);
	console.log(y2);
    overlay.style.left = `${x1+39}px`;
    overlay.style.top = `${y1}px`;
	overlay.style.width = `${x2 - x1}px`;
	overlay.style.height = `${y2 - y1}px`;
}

document.addEventListener('DOMContentLoaded', function () {
	const queryDropdown = document.getElementById('query-dropdown');
	const exampleDropdown = document.getElementById('example-dropdown');
	const questionContainer = document.getElementById('question-container-amb');
	const answersContainer = document.getElementById('answers-container-amb');

	function renderQuestion(queryType, example) {
		// Clear previous content
		questionContainer.innerHTML = '';
		answersContainer.innerHTML = '';
		const exampleId = QsExamples[example + '_' + queryType];
		const exampleData = qsData.filter(item => item.id === exampleId)[0];

		// Question data
		const questionData = {
			text: `[${exampleData.video_id} / ${exampleId}] ${exampleData.question}`,
			image: exampleData.question_image.map(img => `static/images/${exampleId}/${img}/0.png`)
		};

		// Answer data
		const answerData = [
			{ text: exampleData.answers['1'].map(item => Array.isArray(item) ? '[' + item.join('-') + ']' : item).join(', '), images: exampleData.answers['1'].map(img => `static/images/${exampleId}/${img}/0.png`) },
			{ text: exampleData.answers['2'].map(item => Array.isArray(item) ? '[' + item.join('-') + ']' : item).join(', '), images: exampleData.answers['2'].map(img => `static/images/${exampleId}/${img}/0.png`) },
			{ text: exampleData.answers['3'].map(item => Array.isArray(item) ? '[' + item.join('-') + ']' : item).join(', '), images: exampleData.answers['3'].map(img => `static/images/${exampleId}/${img}/0.png`) },
			{ text: exampleData.answers['4'].map(item => Array.isArray(item) ? '[' + item.join('-') + ']' : item).join(', '), images: exampleData.answers['4'].map(img => `static/images/${exampleId}/${img}/0.png`) },
			{ text: exampleData.answers['5'].map(item => Array.isArray(item) ? '[' + item.join('-') + ']' : item).join(', '), images: exampleData.answers['5'].map(img => `static/images/${exampleId}/${img}/0.png`) }
		];

		// Render question
		let questionHTML = `<div class="box"><p class="is-size-5">${questionData.text}</p>`;
		if (['Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'].includes(queryType)) {
			questionHTML += `<img src="${questionData.image}" alt="Question Image" class="mt-3" style="max-width: 100%; height: auto;">`;
		}
		questionHTML += '</div>';
		questionContainer.innerHTML = questionHTML;

		// Render answers
		let answersHTML = '<div class="columns is-multiline">';
		answerData.forEach((answer, index) => {
			const isCorrect = index + 1 === parseInt(exampleData.correct);
			const backgroundColor = isCorrect ? 'background-color: #77DD77;' : '';

			answersHTML += `
				<div class="column">
					<div class="box" style="${backgroundColor}">
					<p class="mb-3">${String.fromCharCode(65 + index)}. ${['Q7', 'Q8'].includes(queryType) ? answer.text : ""}</p>
				`;

			if (['Q1', 'Q5', 'Q6'].includes(queryType)) {
				answersHTML += `<div class="is-flex is-flex-wrap-wrap is-justify-content-center">`;
				answer.images.forEach(img => {
					answersHTML += `<img src="${img}" alt="Answer Image" class="m-1" style="max-width: 100%; height: auto;">`;
				});
				answersHTML += '</div>';
			} else if (['Q2', 'Q3', 'Q4'].includes(queryType)) {
				answersHTML += `<img src="${answer.images[0]}" alt="Answer Image" style="max-width: 100%; height: auto;">`;
			}

			answersHTML += `
            </div>
          </div>
        `;
		});
		answersHTML += '</div>';
		answersContainer.innerHTML = answersHTML;
	}

	queryDropdown.addEventListener('change', () => renderQuestion(queryDropdown.value, exampleDropdown.value));
	exampleDropdown.addEventListener('change', () => renderQuestion(queryDropdown.value, exampleDropdown.value));

	// Initial render
	renderQuestion(queryDropdown.value, exampleDropdown.value);

	const imageMap = document.querySelector('img[usemap]');
	const areas = document.querySelectorAll('area');
	const videoPreview = document.getElementById('video-preview');
	let currentVideo = null;
	let currentArea = null;

	function resizeAreas() {
		const currentWidth = imageMap.clientWidth;
		const currentHeight = imageMap.clientHeight;
		const originalWidth = imageMap.naturalWidth;
		const originalHeight = imageMap.naturalHeight;
		const widthRatio = currentWidth / originalWidth;
		const heightRatio = currentHeight / originalHeight;

		areas.forEach(function (area) {
			const originalCoords = area.getAttribute("data-original-coords").split(',').map(Number);
			const scaledCoords = originalCoords.map(function (coord, index) {
				return (index % 2 === 0) ? Math.round(coord * widthRatio) : Math.round(coord * heightRatio);
			});
			area.setAttribute("coords", scaledCoords.join(','));
		});
		if (currentOverlay) {
			const currentArea = Array.from(areas).find(area => area === currentArea);
			if (currentArea) {
				positionOverlay(currentOverlay, currentArea.getAttribute('coords'));
			}
		}
	}

	// Store the original coordinates in a data attribute.
	areas.forEach(function (area) {
		area.setAttribute("data-original-coords", area.getAttribute("coords"));
	});

	// Adjust the coordinates when the window is resized.
	window.addEventListener("resize", resizeAreas);

	// Run it once when the page loads to adjust the coordinates initially.
	resizeAreas();

	areas.forEach(area => {
		area.addEventListener('mousemove', handleMouseMove);
		area.addEventListener('mouseleave', hideVideo);
	});

	function handleMouseMove(event) {

		const area = event.target;
		if (area !== currentArea) {
			showVideo(area);
			currentArea = area;

			// Remove previous overlay
			if (currentOverlay) {
				currentOverlay.remove();
			}

			// Create and show new overlay
			const coords = area.getAttribute('coords');
			currentOverlay = createOverlay(coords, 'yellow');
			imageMap.parentNode.appendChild(currentOverlay);
		}
		updateVideoPosition(event);
	}

	function showVideo(area) {
		const videoSrc = area.getAttribute('data-video');
		if (!currentVideo || currentVideo.src !== videoSrc) {
			const video = document.createElement('video');
			video.src = videoSrc;
			video.autoplay = true;
			video.loop = true;
			video.muted = true;
			video.style.height = 'auto';
			video.style.padding = '0px';
			videoPreview.style.zIndex = '1000';

			videoPreview.innerHTML = '';
			videoPreview.appendChild(video);
			currentVideo = video;
		}

		videoPreview.style.display = 'block';
		updatePreviewSize();
	}

	function updatePreviewSize() {
		const viewportWidth = window.innerWidth;
		const maxWidth = 300; // Maximum width in pixels
		const minWidth = 150; // Minimum width in pixels
		const widthPercentage = 20; // Percentage of viewport width

		let newWidth = Math.floor(viewportWidth * (widthPercentage / 100));
		newWidth = Math.min(Math.max(newWidth, minWidth), maxWidth);

		videoPreview.style.width = `${newWidth}px`;
	}

	function updateVideoPosition(event) {
		const rect = imageMap.getBoundingClientRect();
		const x = event.clientX - rect.left;
		const y = event.clientY - rect.top;

		const previewRect = videoPreview.getBoundingClientRect();
		const previewWidth = previewRect.width;
		const previewHeight = previewRect.height;

		let previewX = x - previewWidth / 2 + 35;
		let previewY = y - previewHeight / 2 + 5;

		videoPreview.style.left = `${previewX}px`;
		videoPreview.style.top = `${previewY}px`;
	}

	function hideVideo() {
		videoPreview.style.display = 'none';
		currentVideo = null;
		currentArea = null;

		// Remove overlay
		if (currentOverlay) {
			currentOverlay.remove();
			currentOverlay = null;
		}
	}
});
